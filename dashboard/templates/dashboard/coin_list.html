{% load static %}
{% load humanize %} <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tracker - Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #181A21; }
        ::-webkit-scrollbar-thumb { background: #3C4658; border-radius: 10px; }
        .table-row-border { border-bottom: 1px solid #3C4658; }
        .news-scroll-container { height: 400px; overflow-y: auto; }
    </style>
</head>
<body class="flex flex-col min-h-screen" style="background-color: #181A21;">
    <header style="background-color: #232B38;" class="fixed top-0 w-full h-24 border-b border-gray-800 z-50">
        <div class="container mx-auto h-full px-6 flex items-center justify-between">
            <div class="flex items-center">
                <img src="{% static 'dashboard/logo.png' %}" alt="CRYPTOnode Logo" class="h-16 w-auto">
            </div>
            <a href="https://www.gauravkhanal.com/" target="_blank"
               class="px-8 py-3 rounded-lg text-white font-bold hover:opacity-90 transition-opacity"
               style="background-color: #54B51F;">Reach out</a>
        </div>
    </header>

    <main class="container mx-auto flex-1 px-6 pt-32 pb-12">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 mb-10">
            <div class="lg:col-span-4">
                <div id="market-card" class="rounded-xl shadow-2xl h-[190px] flex flex-col p-4 relative overflow-hidden" style="background-color: #232B38;">
                    <h2 class="text-xs font-bold mb-2 uppercase tracking-tight text-center" style="color: #E7C100;">CRYPTO COINS MARKET VALUE</h2>
                    
                    <div class="w-full flex-1 px-0 overflow-hidden">
                        <canvas id="marketBarChart"></canvas>
                    </div>

                    <div class="flex gap-6 mt-3 justify-center shrink-0">
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-sm" style="background-color: #54B51F;"></div>
                            <span class="text-[10px] text-gray-300 font-bold uppercase">Today</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-sm" style="background-color: #E7C100;"></div>
                            <span class="text-[10px] text-gray-300 font-bold uppercase">All time high</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 flex gap-10">
                <div class="rounded-xl shadow-2xl h-[190px] w-48 flex flex-col p-4 items-center" style="background-color: #232B38;">
                    <h2 class="text-xs font-bold mb-2 uppercase tracking-tight text-center" style="color: #E7C100;">ACTIVE CRYPTOS</h2>
                    <div class="flex flex-1 items-center justify-center">
                        <span class="text-4xl font-bold text-white tracking-tighter">{{ market.total_cryptos|intcomma|default:"0" }}</span>
                    </div>
                </div>

                <div class="rounded-xl shadow-2xl h-[190px] w-48 flex flex-col p-4 items-center" style="background-color: #232B38;">
                    <h2 class="text-xs font-bold mb-2 uppercase tracking-tight text-center" style="color: #E7C100;">MARKET IN 24 HRS</h2>
                    <div class="flex flex-1 items-center justify-center gap-2">
                        <span class="text-4xl font-bold tracking-tighter {% if market.market_cap_change_24h < 0 %}text-red-500{% else %}text-[#54B51F]{% endif %}">
                            {{ market.market_cap_change_24h|floatformat:1 }}%
                        </span>
                        <i data-lucide="trending-{% if market.market_cap_change_24h < 0 %}down{% else %}up{% endif %}" 
                           class="w-8 h-8 {% if market.market_cap_change_24h < 0 %}text-red-500{% else %}text-[#54B51F]{% endif %}"></i>
                    </div>
                </div>
                
                <div class="flex-1"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 mb-12">
            <div class="lg:col-span-5">
                <h2 class="text-xl font-bold mb-4 uppercase tracking-tight" style="color: #E7C100;">Top 5 coins</h2>
                <div class="rounded-xl p-6 shadow-2xl" style="background-color: #232B38; height: 472px;">
                    <canvas id="top5PieChart"></canvas>
                </div>
            </div>
            <div class="lg:col-span-7">
                <h2 class="text-xl font-bold mb-4 uppercase tracking-tight" style="color: #E7C100;">NEWS</h2>
                <div class="rounded-xl shadow-2xl overflow-hidden" style="background-color: #232B38; height: 472px;">
                    <div class="news-scroll-container px-4 py-2" style="height: 100%;">
                        {% for article in news_board %}
                        <a href="{{ article.url }}" target="_blank" class="block group border-b border-gray-700 last:border-0 py-3 hover:bg-[#2d3748] transition-all rounded-lg px-2">
                            <div class="flex gap-4 items-start">
                                <div class="w-[72px] h-[72px] shrink-0 rounded overflow-hidden bg-[#181A21]">
                                    <img src="{{ article.thumbnail_link }}" alt="News" class="w-full h-full object-cover">
                                </div>
                                <div class="flex flex-col">
                                    <h3 class="text-white font-bold text-sm group-hover:text-[#E7C100] transition-colors line-clamp-2 leading-tight mb-1">{{ article.title }}</h3>
                                    <p class="text-gray-400 text-[11px] line-clamp-3 leading-tight">{{ article.description }}</p>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    
            <div class="rounded-xl overflow-hidden shadow-2xl" style="background-color: #232B38;">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[#E7C100] text-sm uppercase tracking-wider table-row-border">
                            <th class="px-6 py-4 font-bold">Today's trend</th>
                            <th class="px-6 py-4 font-bold">Coin</th>
                            <th class="px-6 py-4 font-bold text-center">Rank</th>
                            <th class="px-6 py-4 font-bold">Price (USD)</th>
                            <th class="px-6 py-4 font-bold text-center">Market Share</th>
                            <th class="px-6 py-4 font-bold">Last 15 mins</th>
                            <th class="px-6 py-4 font-bold">Last 24 hours</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-300">
                        {% for coin in coins %}
                        <tr class="table-row-border hover:bg-[#2d3748] transition-colors">
                            <td class="px-6 py-4 w-40">
                                <div class="h-12 w-28 bg-[#181A21] rounded p-1"><canvas id="chart-{{ forloop.counter }}"></canvas></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-white text-lg">{{ coin.name }}</span>
                                    <span class="rounded px-2 py-0.5 text-xs font-bold border" style="border-color: #E7C100; color: #E7C100;">{{ coin.symbol }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">{{ coin.rank }}</td>
                            <td class="px-6 py-4 font-medium text-white">{{ coin.trading_price|floatformat:2 }}</td>
                            <td class="px-6 py-4 text-center">{{ coin.market_cap_percent }}%</td>
                            <td class="px-6 py-4 font-bold">
                                <span class="flex items-center gap-1 {% if coin.charts.fifteen_min < 0 %}text-red-500{% else %}text-[#54B51F]{% endif %}">
                                    {{ coin.charts.fifteen_min }}% <i data-lucide="trending-{% if coin.charts.fifteen_min < 0 %}down{% else %}up{% endif %}" class="w-4 h-4"></i>
                                </span>
                            </td>
                            <td class="px-6 py-4 font-bold">
                                <span class="flex items-center gap-1 {% if coin.charts.twentyfour_hour < 0 %}text-red-500{% else %}text-[#54B51F]{% endif %}">
                                    {{ coin.charts.twentyfour_hour }}% <i data-lucide="trending-{% if coin.charts.twentyfour_hour < 0 %}down{% else %}up{% endif %}" class="w-4 h-4"></i>
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        Chart.register(ChartDataLabels);

        // JavaScript chart initialization logic remains the same...
        function wrapText(text, maxLength) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + word).length > maxLength) {
                    lines.push(currentLine.trim());
                    currentLine = word + ' ';
                } else { currentLine += word + ' '; }
            });
            lines.push(currentLine.trim());
            return lines;
        }

        const coinChartData = [{% for coin in coins %}{canvasId: 'chart-{{ forloop.counter }}', data: [{{ coin.charts.twentyfour_hour }}, {{ coin.charts.twelve_hour }}, {{ coin.charts.six_hour }}, {{ coin.charts.one_hour }}, {{ coin.charts.thirty_min }}, {{ coin.charts.fifteen_min }}], isPositive: {{ coin.charts.fifteen_min }} >= 0}{% if not forloop.last %},{% endif %}{% endfor %}];
        coinChartData.forEach(c => { const ctx = document.getElementById(c.canvasId); if(ctx) new Chart(ctx, { type: 'line', data: { labels: ['','','','','',''], datasets: [{ data: c.data, borderColor: c.isPositive ? '#54B51F' : '#ef4444', backgroundColor: 'transparent', borderWidth: 2, tension: 0.4, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false }, datalabels: { display: false } }, scales: { x: { display: false }, y: { display: false } } } }); });

        const barCtx = document.getElementById('marketBarChart').getContext('2d');
        const marketChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: ['Today', 'ATH '],
                datasets: [{
                    data: [{{ market.today_market_cap_percent }}, 100],
                    backgroundColor: ['#54B51F', '#E7C100'],
                    barThickness: 32,
                    borderRadius: {topRight: 4, bottomRight: 4},
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { left: -10, right: 15 } },
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false },
                    tooltip: {
                        backgroundColor: '#181A21',
                        bodyFont: { size: 10 },
                        displayColors: false,
                        callbacks: {
                            title: (items) => items[0].label,
                            label: function(context) {
                                const cap = (context.dataIndex === 0) ? "{{ market.today_market_cap }}" : "{{ market.ath_market_cap }}";
                                const word = (context.dataIndex === 0) ? "{{ market.today_market_cap_amount_word }}" : "{{ market.ath_market_cap_amount_word }}";
                                return [
                                    `$${Number(cap).toLocaleString()}`,
                                    ...wrapText(`${word}`, 45)
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: { display: false, max: 110, beginAtZero: true },
                    y: { display: false, categoryPercentage: 1.0, barPercentage: 1.0 }
                },
                onHover: (event, elements) => {
                    const chart = marketChart;
                    if (elements.length > 0) {
                        event.native.target.style.cursor = 'pointer';
                        chart.data.datasets[0].barThickness = 38;
                    } else {
                        event.native.target.style.cursor = 'default';
                        chart.data.datasets[0].barThickness = 32;
                    }
                    chart.update('none');
                }
            }
        });

        const pieCtx = document.getElementById('top5PieChart').getContext('2d');
        new Chart(pieCtx, { type: 'pie', data: { labels: [{% for item in pie_chart %}"{{ item.name }}"{% if not forloop.last %}, {% endif %}{% endfor %}], datasets: [{ data: [{% for item in pie_chart %}{{ item.market_cap_percent }}{% if not forloop.last %}, {% endif %}{% endfor %}], amounts: [{% for item in pie_chart %}{{ item.market_cap_amount }}{% if not forloop.last %}, {% endif %}{% endfor %}], backgroundColor: ['#54B51F', '#E7C100', '#3B82F6', '#8B5CF6', '#F97316', '#4B5563'], borderWidth: 2, borderColor: '#232B38', radius: '90%', hoverOffset: 25 }] }, options: { responsive: true, maintainAspectRatio: false, layout: { padding: 35 }, plugins: { legend: { position: 'bottom', labels: { color: '#D1D5DB', usePointStyle: true, font: { weight: 'bold' } } }, tooltip: { callbacks: { label: (c) => `${c.label}: $${c.dataset.amounts[c.dataIndex].toLocaleString()}` } }, datalabels: { color: '#D1D5DB', anchor: 'end', align: 'end', font: { weight: 'bold', size: 11 }, formatter: (v) => v + '%' } } } });
    </script>
</body>
</html>